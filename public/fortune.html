<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>每日运势 - Yuan的个人主页</title>
    <script src="assets/js/theme-sync.js"></script>
    <link href="assets/css/theme.css" rel="stylesheet" />
    <link rel="icon" href="assets/img/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { background: linear-gradient(135deg, #e0f2fe 0%, #f3e8ff 50%, #e0f2fe 100%); }
        .fortune-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .fortune-card {
            background: transparent;
            padding: 2rem;
            border-radius: 0;
            width: 100%;
            max-width: 420px; 
            box-shadow: none;
            text-align: center;
        }
        
        .fortune-title {
            font-size: 1rem;
            color: var(--text-color-secondary);
            margin-bottom: 0.5rem;
        }

        .luck-level {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-color-primary);
            margin-bottom: 0.75rem;
        }

        .star-rating {
            font-size: 1.5rem;
            color: #f59e0b; 
            margin-bottom: 1.5rem;
        }
        .star-rating .empty {
            color: var(--border-color);
        }

        .quote {
            font-size: 1rem;
            color: var(--text-color-secondary);
            margin-bottom: 1.5rem;
            min-height: 2em; 
        }

        .fortune-image {
            width: 100%;
            height: auto;
            border-radius: var(--border-radius-small);
            margin-bottom: 1.5rem;
            background-color: var(--border-color); 
            min-height: 200px; 
            object-fit: cover; 
        }

        .disclaimer {
            font-size: 0.8rem;
            color: #9ca3af; 
            line-height: 1.4;
        }
    </style>
</head>
<body>

    <nav class="navbar fixed-top">
      <div class="container navbar-content">
        <a class="navbar-brand h1" href="index.html">YUAN</a>
        
        <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>

        <div class="nav-items" id="nav-items">
          <ul>
            <li><a class="nav-link" href="#about">关于我</a></li>
            <li><a class="nav-link" href="#projects">我的作品</a></li>
            <li><a class="nav-link" href="fortune.html">每日运势</a></li>
            <li><a class="nav-link" href="#contact">联系我</a></li>
          </ul>

          <a href="login.html" class="btn btn-sm btn-outline-primary" id="login-button">登录</a>

          <div class="user-dropdown" id="user-dropdown" style="display: none;">
            <button class="user-dropdown-toggle" id="user-dropdown-toggle" aria-label="用户菜单">
              <i class="fas fa-user-circle"></i>
              <span id="user-email"></span>
            </button>
            <div class="dropdown-menu" id="dropdown-menu">
              <a href="profile.html" class="dropdown-item">个人资料</a>
              <a href="#" class="dropdown-item" id="logout-button">退出登录</a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <script>
        const userToken = localStorage.getItem('userToken');
        if (!userToken) {
            alert('请先登录才能查看今日运势！');
            window.location.href = 'login.html';
        }
    </script>

    <div class="fortune-container">
        <div class="fortune-card">
            <p class="fortune-title">您的今日运势为:</p>
            <h1 id="luck-level-text" class="luck-level text-gradient">正在揭晓...</h1>
            <div id="star-rating" class="star-rating"></div>
            
            <p class="quote" id="hitokoto-text">正在获取今日一言...</p>
            
            <img id="fortune-image" class="fortune-image" alt="随机风景图" src="">
            
            <p class="disclaimer">
                图片源自网络|如有侵权|请反馈删除<br>
                仅供娱乐|相信科学|请勿迷信
            </p>
            
            <p class="text-center" style="margin-top: 1.5rem; margin-bottom: 0;"><a href="index.html">返回主页</a></p>
        </div>
    </div>
    
    <script>
        const luckLevelElement = document.getElementById('luck-level-text');
        const starRatingElement = document.getElementById('star-rating');
        const hitokotoElement = document.getElementById('hitokoto-text');
        const imageElement = document.getElementById('fortune-image');


        function generateStars(luckNumber) {

            const filledStars = Math.max(1, Math.ceil(luckNumber / 16.67));
            const emptyStars = 6 - filledStars;
            
            let starsHTML = '';
            for (let i = 0; i < filledStars; i++) {
                starsHTML += '★';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<span class="empty">☆</span>';
            }
            return starsHTML;
        }

        async function fetchAndDisplayFortune() {
            try {
                const response = await fetch('/api/fortune', {
                    headers: {
                        'Authorization': `Bearer ${userToken}` 
                    }
                });


                if (response.status === 401 || response.status === 403) {
                    alert('您的登录已过期，请重新登录。');
                    localStorage.removeItem('userToken'); 
                    window.location.href = 'login.html';
                    return; 
                }

                const data = await response.json();


                if (!response.ok) {
                    throw new Error(data.message || '获取运势失败，服务器可能出错了。');
                }


                let levelText = data.luck_level_text;
                if (data.wealth_luck >= 7) levelText += '+财运';
                if (data.career_luck >= 7) levelText += '+官运';
                luckLevelElement.textContent = levelText;


                starRatingElement.innerHTML = generateStars(data.luck_number);
                

                hitokotoElement.textContent = data.quote;
                imageElement.src = data.image_url;

            } catch (error) {

                console.error('获取运势失败:', error);
                luckLevelElement.textContent = '获取失败';
                // 根据错误类型显示更友好的信息
                if (error.message.includes('JSON')) {
                    hitokotoElement.textContent = '与服务器通信时发生格式错误，可能是登录过期，请尝试重新登录。';
                } else {
                    hitokotoElement.textContent = error.message;
                }
            }
        }

        // 页面加载时并且确认用户已登录后，自动执行
        if (userToken) {
            document.addEventListener('DOMContentLoaded', fetchAndDisplayFortune);
        }
    </script>

    <script src="assets/js/global.js" defer></script> 
</body>
</html>